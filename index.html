<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monster Omakase - Ultimate Stable Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Mali:wght@400;700&family=Fredoka:wght@600&display=swap');

        /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ú‡∏•‡∏≠‡∏Ñ‡∏•‡∏∏‡∏°‡∏î‡∏≥‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏ô iPad */
        body { margin: 0; padding: 0; background-color: #2c3e50; display: flex; justify-content: center; align-items: center; height: 100vh; font-family: 'Fredoka', 'Mali', sans-serif; overflow: hidden; touch-action: none; -webkit-user-select: none; user-select: none; }
        
        #game-container { width: 100%; max-width: 900px; aspect-ratio: 16 / 9; background-color: #000; position: relative; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border-radius: 20px; border: 8px solid #34495e; }
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; justify-content: center; align-items: center; background-size: cover; background-position: center; background-repeat: no-repeat; }
        .active { display: flex; }

        /* --- Backgrounds --- */
        #home-screen { background-image: url('‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å.png'); justify-content: flex-end; padding-bottom: 40px; }
        #how-to-screen { background-image: url('‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å.png'); background-color: rgba(255,255,255,0.9); background-blend-mode: overlay; }
        #characters-screen { background-image: url('monster characters.png'); background-size: contain; background-color: #fad390; }
        #mode-screen { background-image: url('‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å.png'); background-color: rgba(255, 255, 255, 0.85); background-blend-mode: overlay; }
        #boss-screen { background-image: url('boss.jpeg'); justify-content: flex-end; padding-bottom: 50px; }
        #result-screen { background-image: url('leader board.png'); justify-content: center; }
        #leaderboard-screen { background-image: url('leader board.png'); justify-content: flex-start; padding-top: 40px; }

        /* --- UI Elements --- */
        .top-bar { position: absolute; top: 20px; width: 100%; display: flex; justify-content: center; align-items: center; z-index: 200; pointer-events: none; }
        .top-bar > div, .top-bar > button { pointer-events: auto; }
        #score-display, #boss-score-display { position: absolute; left: 30px; font-size: 2rem; color: #333; text-shadow: 2px 2px #fff; font-weight: bold; }
        #timer-display, #boss-timer-display { font-size: 2.2rem; color: #ff4757; background: rgba(255,255,255,0.8); padding: 5px 20px; border-radius: 20px; border: 3px solid #ff4757; }
        .btn-home { position: absolute; right: 30px; background-color: #54a0ff; box-shadow: 0 5px 0 #2e86de; border: none; color: white; border-radius: 50px; padding: 10px 20px; cursor: pointer; font-family: 'Fredoka', sans-serif; font-size: 1.2rem; }

        .title-3d { font-size: 3.5rem; color: #fff; text-shadow: 0 2px 0 #ff6b81, 0 4px 0 #ff6b81, 0 6px 0 #ff6b81, 0 8px 0 #ff6b81, 0 10px 15px rgba(0,0,0,0.4); margin-bottom: 20px; text-align: center; }
        .target-word { font-size: 6rem; color: #fffa65; font-weight: bold; text-shadow: 4px 4px 0px #ff4757, 8px 8px 0px #333, 10px 10px 20px rgba(0,0,0,0.5); margin-bottom: 20px; z-index: 20; letter-spacing: 5px; }
        .btn { padding: 12px 30px; font-size: 1.5rem; background-color: #ff9ff3; color: white; border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 6px 0 #f368e0; font-family: 'Fredoka', sans-serif; margin: 5px; transition: all 0.1s; -webkit-tap-highlight-color: transparent; }
        .btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #f368e0; }
        
        .mic-active-effect { box-shadow: 0 0 20px #ff6b81, 0 10px 0 #c0392b !important; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* --- Game Elements: ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏õ‡∏≤‡∏Å‡∏°‡∏≠‡∏ô‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô --- */
        .mouth-zone { 
            position: absolute; border-radius: 50%; z-index: 10; 
            border: 4px dashed rgba(255, 255, 255, 0.7); 
            background: rgba(255, 255, 255, 0.2); 
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }
        .conveyor-belt { position: absolute; bottom: 0; width: 100%; height: 120px; z-index: 15; pointer-events: none; }
        
        /* --- Sushi Art --- */
        .sushi-wrapper { position: absolute; bottom: 25px; display: flex; flex-direction: column; align-items: center; cursor: grab; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.4)); z-index: 150; touch-action: none; transition: transform 0.1s; }
        .sushi-topping { width: 110%; height: 28px; border-radius: 20px 20px 5px 5px; margin-bottom: -10px; z-index: 2; border: 2px solid rgba(0,0,0,0.1); border-bottom: none; }
        .sushi-rice { background: #fff; border: 3px solid #ccc; padding: 5px 25px; border-radius: 10px 10px 20px 20px; font-size: 1.6rem; font-weight: bold; color: #333; z-index: 1; text-align: center; box-shadow: inset -4px -4px 6px rgba(0,0,0,0.08); }

        .topping-1 { background: repeating-linear-gradient(45deg, #ff7f50, #ff7f50 10px, #ff9f7a 10px, #ff9f7a 20px); }
        .topping-2 { background: #e74c3c; }
        .topping-3 { background: #f1c40f; position: relative; }
        .topping-3::after { content: ''; position: absolute; left: 40%; width: 20%; height: 130%; background: #2f3640; top: -15%; border-radius: 2px; z-index: 3; }
        .topping-4 { background: repeating-linear-gradient(90deg, #fff, #fff 10px, #ff6b81 10px, #ff6b81 20px); border: 2px solid #ff6b81; }
        .topping-5 { background: radial-gradient(circle, #ff9f43 40%, transparent 40%), #2f3640; background-size: 15px 15px; border-radius: 10px 10px 0 0; }

        /* --- Feedback --- */
        .feedback-pop { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%) scale(0); font-size: 5.5rem; font-weight: bold; z-index: 9999; pointer-events: none; text-shadow: 5px 5px 0 #000; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .feedback-pop.show { transform: translate(-50%, -50%) scale(1.2); }
        .correct { color: #2ed573; } .wrong { color: #ff4757; }
        
        /* Tables */
        .ranking-container { width: 85%; background: rgba(255, 255, 255, 0.9); border-radius: 20px; padding: 15px; max-height: 60%; overflow-y: auto; border: 4px solid #ff9ff3; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #ff6b81; color: white; padding: 10px; position: sticky; top: 0; }
        td { padding: 8px; border-bottom: 1px solid #ddd; text-align: center; }
    </style>
</head>
<body>

<audio id="bg-music" src="bg-music.mp3" loop preload="auto"></audio>

<div id="game-container">
    <div id="home-screen" class="screen active">
        <button class="btn" style="background-color: #54a0ff; box-shadow: 0 5px 0 #2e86de;" onclick="showScreen('how-to-screen')">How to Play</button>
        <button class="btn" style="font-size: 2.5rem; padding: 20px 60px;" onclick="startGameSession()">START</button>
    </div>

    <div id="how-to-screen" class="screen">
        <button class="btn" style="position: absolute; top: 15px; left: 15px; background-color: #ee5253; box-shadow: 0 4px 0 #c0392b;" onclick="showScreen('home-screen')">‚¨Ö Back</button>
        <div style="background: white; padding: 25px; border-radius: 30px; width: 80%; text-align: left; border: 6px solid #ff9ff3; box-shadow: 0 10px 20px rgba(0,0,0,0.1);">
            <h1 class="title-3d" style="font-size: 3rem; margin-top: 0; color: #ff6b81; text-shadow: none;">How to Play üí°</h1>
            <p>1. <b>Drag & Drop:</b> ‡∏•‡∏≤‡∏Å‡∏ã‡∏π‡∏ä‡∏¥‡πÑ‡∏õ‡∏õ‡πâ‡∏≠‡∏ô‡∏õ‡∏≤‡∏Å‡∏°‡∏≠‡∏ô‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</p>
            <p>2. <b>Listening:</b> ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå Native ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏∞‡∏™‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>
            <p>3. <b>Boss Stage:</b> ‡∏Å‡∏î‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÑ‡∏°‡∏Ñ‡πå 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≠‡∏ö‡πÑ‡∏ß‡∏õ‡∏≤‡∏ô‡∏™‡∏≤‡∏¢‡∏ü‡πâ‡∏≤!</p>
            <div style="display: flex; justify-content: center; gap: 15px; margin-top: 20px;">
                <button class="btn" style="background-color: #ff9f43; box-shadow: 0 6px 0 #e67e22;" onclick="showScreen('characters-screen')">üëæ Meet Monsters</button>
                <button class="btn" onclick="showScreen('mode-screen')">Let's Go!</button>
            </div>
        </div>
    </div>

    <div id="characters-screen" class="screen">
        <button class="btn" style="position: absolute; top: 15px; left: 15px; background-color: #ee5253; z-index: 100;" onclick="showScreen('how-to-screen')">‚¨Ö Back</button>
        <button class="btn" style="position: absolute; top: 15px; right: 15px; background-color: #54a0ff; z-index: 100;" onclick="showScreen('mode-screen')">Ready! ‚ñ∂</button>
    </div>

    <div id="mode-screen" class="screen">
        <button class="btn" style="position: absolute; top: 15px; left: 15px; background-color: #ee5253;" onclick="showScreen('home-screen')">‚¨Ö Back</button>
        <h1 class="title-3d">Select Mode üç±</h1>
        <button class="btn" onclick="startGame(1)">Mode 1: Color & Shape</button>
        <button class="btn" onclick="startGame(2)">Mode 2: Pet & Wild</button>
        <button class="btn" onclick="startGame(3)">Mode 3: Body & School</button>
    </div>

    <div id="game-screen" class="screen">
        <div class="top-bar">
            <div id="score-display">Score: 0</div>
            <div id="timer-display">Time: 30</div>
            <button class="btn-home" onclick="location.reload()">üè† Home</button>
        </div>
        <div id="mouth-left" class="mouth-zone"></div>
        <div id="mouth-right" class="mouth-zone"></div>
        <div class="conveyor-belt" id="conveyor"></div>
        <div id="big-feedback" class="feedback-pop">Correct!</div>
    </div>

    <div id="boss-screen" class="screen">
        <div class="top-bar">
            <div id="boss-score-display">Score: 0</div>
            <div id="boss-timer-display">Time: 30</div>
            <button class="btn-home" onclick="location.reload()">üè† Home</button>
        </div>
        <h1 class="title-3d" style="position: absolute; top: 100px;">BOSS STAGE</h1>
        <div class="target-word" id="word-to-say">Word</div>
        <button class="btn" id="mic-btn" style="background-color: #ff4757;" onclick="startListening()">üé§ Tap to Start Mic</button>
        <div id="boss-feedback" class="feedback-pop">Correct!</div>
    </div>

    <div id="result-screen" class="screen">
        <div style="background: rgba(255,255,255,0.95); padding: 40px; border-radius: 30px; text-align: center; border: 6px solid #ff9ff3;">
            <h1 style="color: #ff6b81;">Excellent! üåü</h1>
            <h2 id="final-score" style="font-size: 3rem; color: #f39c12;">Score: 0</h2>
            <input type="text" id="player-name" style="padding: 10px; font-size: 1.5rem; text-align: center;" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
            <br><br><button class="btn" onclick="saveScore()">Save Rank</button>
        </div>
    </div>

    <div id="leaderboard-screen" class="screen">
        <h1 class="title-3d">üèÜ Ranking Table</h1>
        <div class="ranking-container"><table id="leaderboard-table"><thead><tr><th>Rank</th><th>Name</th><th>Score</th><th>Stars</th><th>Del</th></tr></thead><tbody></tbody></table></div>
        <button class="btn" onclick="location.reload()">Play Again</button>
    </div>
</div>

<script>
    const modesConfig = {
        1: { bg: "url('‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà 1.png')", vocab: [{word:"Red",cat:"color"}, {word:"Blue",cat:"color"}, {word:"Green",cat:"color"}, {word:"Yellow",cat:"color"}, {word:"Pink",cat:"color"}, {word:"Black",cat:"color"}, {word:"White",cat:"color"}, {word:"Orange",cat:"color"}, {word:"Purple",cat:"color"}, {word:"Brown",cat:"color"}, {word:"Circle",cat:"shape"}, {word:"Square",cat:"shape"}, {word:"Triangle",cat:"shape"}, {word:"Star",cat:"shape"}, {word:"Heart",cat:"shape"}, {word:"Oval",cat:"shape"}, {word:"Diamond",cat:"shape"}, {word:"Cross",cat:"shape"}, {word:"Arrow",cat:"shape"}, {word:"Line",cat:"shape"}], leftMouth:{cat:"shape",l:"28%",t:"32%",w:"22%",h:"25%"}, rightMouth:{cat:"color",l:"70%",t:"43%",w:"16%",h:"18%"} },
        2: { bg: "url('‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà 2.png')", vocab: [{word:"Dog",cat:"pet"}, {word:"Cat",cat:"pet"}, {word:"Fish",cat:"pet"}, {word:"Bird",cat:"pet"}, {word:"Rabbit",cat:"pet"}, {word:"Hamster",cat:"pet"}, {word:"Turtle",cat:"pet"}, {word:"Mouse",cat:"pet"}, {word:"Parrot",cat:"pet"}, {word:"Puppy",cat:"pet"}, {word:"Lion",cat:"wild"}, {word:"Tiger",cat:"wild"}, {word:"Elephant",cat:"wild"}, {word:"Monkey",cat:"wild"}, {word:"Bear",cat:"wild"}, {word:"Snake",cat:"wild"}, {word:"Zebra",cat:"wild"}, {word:"Giraffe",cat:"wild"}, {word:"Hippo",cat:"wild"}, {word:"Fox",cat:"wild"}], leftMouth:{cat:"wild",l:"32%",t:"38%",w:"15%",h:"20%"}, rightMouth:{cat:"pet",l:"69%",t:"35%",w:"12%",h:"16%"} },
        3: { bg: "url('‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà 3.png')", vocab: [{word:"Head",cat:"body"}, {word:"Eye",cat:"body"}, {word:"Ear",cat:"body"}, {word:"Nose",cat:"body"}, {word:"Mouth",cat:"body"}, {word:"Arm",cat:"body"}, {word:"Hand",cat:"body"}, {word:"Leg",cat:"body"}, {word:"Foot",cat:"body"}, {word:"Hair",cat:"body"}, {word:"Pen",cat:"school"}, {word:"Pencil",cat:"school"}, {word:"Book",cat:"school"}, {word:"Ruler",cat:"school"}, {word:"Eraser",cat:"school"}, {word:"Desk",cat:"school"}, {word:"Chair",cat:"school"}, {word:"Bag",cat:"school"}, {word:"Paper",cat:"school"}, {word:"Board",cat:"school"}], leftMouth:{cat:"body",l:"29%",t:"42%",w:"15%",h:"22%"}, rightMouth:{cat:"school",l:"62%",t:"38%",w:"12%",h:"20%"} }
    };

    const fuzzyDict = { "red":["red","‡πÄ‡∏£‡∏î"], "blue":["blue","‡∏ö‡∏•‡∏π"], "green":["green","‡∏Å‡∏£‡∏µ‡∏ô"], "yellow":["yellow","‡πÄ‡∏¢‡∏•‡πÇ‡∏•‡πà"], "pink":["pink","‡∏û‡∏¥‡∏á‡∏Ñ‡πå"], "black":["black","‡πÅ‡∏ö‡∏•‡πá‡∏Ñ"], "white":["white","‡πÑ‡∏ß‡∏ó‡πå"], "orange":["orange","‡∏≠‡∏≠‡πÄ‡∏£‡∏ô‡∏à‡πå"], "purple":["purple","‡πÄ‡∏û‡∏≠‡πÄ‡∏û‡∏¥‡∏•"], "brown":["brown","‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡πå"], "circle":["circle","‡πÄ‡∏ã‡∏≠‡πÄ‡∏Ñ‡∏¥‡∏•"], "square":["square","‡∏™‡πÅ‡∏Ñ‡∏ß‡∏£‡πå"], "triangle":["triangle","‡πÑ‡∏ó‡∏£‡πÅ‡∏≠‡∏á‡πÄ‡∏Å‡∏¥‡∏•"], "star":["star","‡∏™‡∏ï‡∏≤‡∏£‡πå"], "heart":["heart","‡∏Æ‡∏≤‡∏£‡πå‡∏ó"], "oval":["oval","‡πÇ‡∏≠‡∏ß‡∏≠‡∏•"], "diamond":["diamond","‡πÑ‡∏î‡∏°‡∏≠‡∏ô‡∏î‡πå"], "cross":["cross","‡∏Ñ‡∏£‡∏≠‡∏™"], "arrow":["arrow","‡πÅ‡∏≠‡∏£‡πå‡πÇ‡∏£‡∏ß‡πå"], "line":["line","‡πÑ‡∏•‡∏ô‡πå"], "dog":["dog","‡∏î‡πá‡∏≠‡∏Å"], "cat":["cat","‡πÅ‡∏Ñ‡∏ó"], "fish":["fish","‡∏ü‡∏¥‡∏ä"], "bird":["bird","‡πÄ‡∏ö‡∏¥‡∏£‡πå‡∏î"], "rabbit":["rabbit","‡πÅ‡∏£‡∏ö‡∏ö‡∏¥‡∏ó"], "hamster":["hamster","‡πÅ‡∏Æ‡∏°‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå"], "turtle":["turtle","‡πÄ‡∏ó‡∏≠‡πÄ‡∏ó‡∏¥‡∏•"], "mouse":["mouse","‡πÄ‡∏°‡∏≤‡∏™‡πå"], "parrot":["parrot","‡πÅ‡∏û‡∏£‡∏£‡∏≠‡∏ï"], "puppy":["puppy","‡∏û‡∏±‡∏û‡∏û‡∏µ‡πà"], "lion":["lion","‡πÑ‡∏•‡∏≠‡∏≠‡∏ô"], "tiger":["tiger","‡πÑ‡∏ó‡πÄ‡∏Å‡∏≠‡∏£‡πå"], "elephant":["elephant","‡πÄ‡∏≠‡πÄ‡∏•‡πÄ‡∏ü‡∏ô‡∏ó‡πå"], "monkey":["monkey","‡∏°‡∏±‡∏á‡∏Å‡∏µ‡πâ"], "bear":["bear","‡πÅ‡∏ö‡∏£‡πå"], "snake":["snake","‡∏™‡πÄ‡∏ô‡πá‡∏Ñ"], "zebra":["zebra","‡∏ã‡∏µ‡∏ö‡∏£‡πâ‡∏≤"], "giraffe":["giraffe","‡∏à‡∏µ‡∏£‡∏≤‡∏ü"], "hippo":["hippo","‡∏Æ‡∏¥‡∏õ‡πÇ‡∏õ"], "fox":["fox","‡∏ü‡πá‡∏≠‡∏Å‡∏ã‡πå"], "head":["head","‡πÄ‡∏Æ‡∏î"], "eye":["eye","‡∏≠‡∏≤‡∏¢"], "ear":["ear","‡πÄ‡∏≠‡∏µ‡∏¢‡∏£‡πå"], "nose":["nose","‡πÇ‡∏ô‡∏™"], "mouth":["mouth","‡πÄ‡∏°‡∏≤‡∏ó‡πå"], "arm":["arm","‡∏≠‡∏≤‡∏£‡πå‡∏°"], "hand":["hand","‡πÅ‡∏Æ‡∏ô‡∏î‡πå"], "leg":["leg","‡πÄ‡∏•‡∏Å"], "foot":["foot","‡∏ü‡∏∏‡∏ï"], "hair":["hair","‡πÅ‡∏Æ‡∏£‡πå"], "pen":["pen","‡πÄ‡∏û‡∏ô"], "pencil":["pencil","‡πÄ‡∏û‡∏ô‡∏ã‡∏¥‡∏•"], "book":["book","‡∏ö‡∏∏‡πä‡∏Ñ"], "ruler":["ruler","‡∏£‡∏π‡πÄ‡∏•‡∏≠‡∏£‡πå"], "eraser":["eraser","‡∏≠‡∏µ‡πÄ‡∏£‡πÄ‡∏ã‡∏≠‡∏£‡πå"], "desk":["desk","‡πÄ‡∏î‡∏™‡∏Å‡πå"], "chair":["chair","‡πÅ‡∏ä‡∏£‡πå"], "bag":["bag","‡πÅ‡∏ö‡πá‡∏Å"], "paper":["paper","‡πÄ‡∏û‡πÄ‡∏û‡∏≠‡∏£‡πå"], "board":["board","‡∏ö‡∏≠‡∏£‡πå‡∏î"] };

    let score = 0, timeLeft = 30, gameInterval, spawnInterval, bossInterval, currentMode, vocabPool = [];
    let currentBossWord = "", isMicActive = false, isBossStageActive = false, isProcessing = false;
    let nativeVoice = null;

    // --- üîä ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á Native ‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ ---
    function loadNativeVoice() {
        const voices = window.speechSynthesis.getVoices();
        if (voices.length === 0) return;
        const preferredNames = ['Google US English', 'Microsoft Zira', 'Microsoft Aria', 'Samantha', 'Karen', 'Daniel'];
        for (let name of preferredNames) {
            nativeVoice = voices.find(v => v.name.includes(name));
            if (nativeVoice) break;
        }
        if (!nativeVoice) nativeVoice = voices.find(v => v.lang.startsWith('en') && (v.name.includes('Premium') || v.name.includes('Enhanced')));
        if (!nativeVoice) nativeVoice = voices.find(v => v.lang === 'en-US') || voices.find(v => v.lang.startsWith('en'));
    }
    loadNativeVoice();
    if (window.speechSynthesis.onvoiceschanged !== undefined) window.speechSynthesis.onvoiceschanged = loadNativeVoice;

    function speak(t) {
        window.speechSynthesis.cancel();
        let msg = new SpeechSynthesisUtterance(t);
        if (!nativeVoice) loadNativeVoice();
        if (nativeVoice) msg.voice = nativeVoice;
        msg.lang = 'en-US'; msg.rate = 0.9;
        window.speechSynthesis.speak(msg);
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.lang = 'en-US';
        recognition.interimResults = true; // ‚ö° ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ß‡∏õ‡∏≤‡∏ô‡∏™‡∏≤‡∏¢‡∏ü‡πâ‡∏≤
        recognition.continuous = true;
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'leaderboard-screen') displayLeaderboard();
    }

    function startGameSession() {
        const music = document.getElementById('bg-music');
        if(music) { music.volume = 0.4; music.play().catch(e => console.log("‡∏£‡∏≠‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö")); }
        let wakeUpVoice = new SpeechSynthesisUtterance(' ');
        wakeUpVoice.volume = 0; window.speechSynthesis.speak(wakeUpVoice);
        showScreen('mode-screen');
    }

    function startGame(m) {
        currentMode = modesConfig[m]; score = 0; timeLeft = 30; vocabPool = [];
        document.getElementById('game-screen').style.backgroundImage = currentMode.bg;
        setupMouths(); showScreen('game-screen');
        gameInterval = setInterval(() => {
            timeLeft--; document.getElementById('timer-display').innerText = `Time: ${timeLeft}`;
            if(timeLeft<=0) endFeeding();
        }, 1000);
        spawnSushi(); spawnInterval = setInterval(spawnSushi, 2000);
    }

    function setupMouths() {
        const ml = document.getElementById('mouth-left'), mr = document.getElementById('mouth-right');
        ml.style.left = currentMode.leftMouth.l; ml.style.top = currentMode.leftMouth.t;
        ml.style.width = currentMode.leftMouth.w; ml.style.height = currentMode.leftMouth.h;
        mr.style.left = currentMode.rightMouth.l; mr.style.top = currentMode.rightMouth.t;
        mr.style.width = currentMode.rightMouth.w; mr.style.height = currentMode.rightMouth.h;
        ml.dataset.cat = currentMode.leftMouth.cat; mr.dataset.cat = currentMode.rightMouth.cat;
    }

    // --- üëÜ ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡πÅ‡∏•‡∏∞‡∏•‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Perfect Touch Tracking) ---
    function spawnSushi() {
        if (vocabPool.length === 0) vocabPool = [...currentMode.vocab];
        const randomIndex = Math.floor(Math.random() * vocabPool.length);
        const item = vocabPool.splice(randomIndex, 1)[0];
        const toppingType = Math.floor(Math.random() * 5) + 1;
        const wrapper = document.createElement('div'); wrapper.className = 'sushi-wrapper'; 
        wrapper.innerHTML = `<div class="sushi-topping topping-${toppingType}"></div><div class="sushi-rice">${item.word}</div>`;
        
        // ‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏Å‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏´‡∏•‡∏∏‡∏î‡∏Å‡∏£‡∏≠‡∏ö
        document.getElementById('game-screen').appendChild(wrapper);
        speak(item.word);

        let isDragging = false;
        
        const handleStart = (e) => { 
            isDragging = true; 
            wrapper.style.zIndex = 1000; 
            wrapper.style.transform = 'scale(1.1)'; // ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö
        };
        
        const handleMove = (e) => {
            if (!isDragging) return; 
            e.preventDefault(); // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏ñ‡∏•‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
            let touch = e.touches ? e.touches[0] : e;
            
            // ‡∏•‡πá‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î Fixed ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏≤‡∏°‡∏ô‡∏¥‡πâ‡∏ß‡πÅ‡∏ö‡∏ö Real-time
            wrapper.style.position = 'fixed';
            wrapper.style.left = (touch.clientX - wrapper.offsetWidth / 2) + 'px';
            wrapper.style.top = (touch.clientY - wrapper.offsetHeight / 2) + 'px';
            wrapper.style.bottom = 'auto';
        };
        
        const handleEnd = (e) => {
            if (!isDragging) return;
            isDragging = false;
            wrapper.style.transform = 'scale(1)';
            
            const sushiRect = wrapper.getBoundingClientRect();
            let matched = false;
            
            document.querySelectorAll('.mouth-zone').forEach(m => {
                const mRect = m.getBoundingClientRect();
                // ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏ô (AABB Collision) ‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
                if (!(sushiRect.right < mRect.left || 
                      sushiRect.left > mRect.right || 
                      sushiRect.bottom < mRect.top || 
                      sushiRect.top > mRect.bottom)) {
                    matched = true; checkMatch(item.cat, m);
                }
            });
            
            if (matched) {
                wrapper.remove();
            } else {
                // ‡∏ñ‡πâ‡∏≤‡∏û‡∏•‡∏≤‡∏î‡πÄ‡∏õ‡πâ‡∏≤ ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏•‡∏≠‡∏¢‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏¢‡∏û‡∏≤‡∏ô
                wrapper.style.position = 'absolute';
                wrapper.style.top = 'auto';
                wrapper.style.bottom = '25px';
            }
        };

        // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÅ‡∏•‡∏∞‡∏ô‡∏¥‡πâ‡∏ß
        wrapper.addEventListener('mousedown', handleStart);
        document.addEventListener('mousemove', handleMove, {passive: false});
        document.addEventListener('mouseup', handleEnd);

        wrapper.addEventListener('touchstart', handleStart, {passive: false});
        wrapper.addEventListener('touchmove', handleMove, {passive: false});
        wrapper.addEventListener('touchend', handleEnd);

        let pos = 100;
        let move = setInterval(() => { 
            if(!isDragging) { 
                pos -= 0.6; wrapper.style.left = pos + '%'; 
                if(pos < -20) { clearInterval(move); if(wrapper.parentNode) wrapper.remove(); } 
            } 
        }, 20);
    }

    function checkMatch(cat, mouth) {
        const correct = (cat === mouth.dataset.cat);
        showFeedback('big-feedback', correct);
        if(correct) { score += 10; speak("Correct!"); } else { speak("Wrong!"); }
        document.getElementById('score-display').innerText = `Score: ${score}`;
    }

    function showFeedback(id, correct) {
        const fb = document.getElementById(id); fb.innerText = correct ? "Correct! ‚úÖ" : "Wrong! ‚ùå";
        fb.className = `feedback-pop show ${correct ? 'correct' : 'wrong'}`;
        setTimeout(() => fb.classList.remove('show'), 800);
    }

    function endFeeding() { clearInterval(gameInterval); clearInterval(spawnInterval); document.querySelectorAll('.sushi-wrapper').forEach(s => s.remove()); startBoss(); }

    function startBoss() {
        showScreen('boss-screen'); let bTime = 30;
        document.getElementById('boss-score-display').innerText = `Score: ${score}`;
        isBossStageActive = true; isMicActive = false; isProcessing = false;
        const btn = document.getElementById('mic-btn');
        btn.innerText = "üé§ Tap to Start Mic"; btn.style.backgroundColor = "#ff4757";
        btn.classList.remove('mic-active-effect'); btn.style.pointerEvents = "auto";

        bossInterval = setInterval(() => { 
            bTime--; document.getElementById('boss-timer-display').innerText = `Time: ${bTime}`; 
            if(bTime<=0) { 
                isBossStageActive = false; isMicActive = false;
                if(recognition) recognition.stop();
                clearInterval(bossInterval); showResult(); 
            } 
        }, 1000);
        nextBossWord();
    }

    function nextBossWord() {
        const word = currentMode.vocab[Math.floor(Math.random() * currentMode.vocab.length)].word;
        currentBossWord = word; document.getElementById('word-to-say').innerText = word; speak(word);
    }

    function startListening() {
        if (!recognition) return alert("‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏ä‡πâ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå Google Chrome ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ñ‡∏£‡∏±‡∏ö!");
        if (isMicActive) return;

        isMicActive = true; isProcessing = false; 
        const btn = document.getElementById('mic-btn'); 
        btn.innerText = "üî¥ Mic Active (‡∏û‡∏π‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!)"; 
        btn.style.backgroundColor = "#ff6b81"; btn.classList.add('mic-active-effect'); btn.style.pointerEvents = "none";
        
        try { recognition.start(); } catch(e) {}

        recognition.onresult = (event) => {
            if (isProcessing || !isBossStageActive) return; 
            
            let currentTranscript = '';
            let isFinalWord = false;
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                currentTranscript += event.results[i][0].transcript.toLowerCase();
                if (event.results[i].isFinal) isFinalWord = true;
            }
            
            let spoken = currentTranscript.trim().replace(/[^a-z‡∏Å-‡∏Æ‡∏∞-‡πå ]/gi, "");
            let isCorrect = spoken.includes(currentBossWord.toLowerCase());
            if (!isCorrect && fuzzyDict[currentBossWord.toLowerCase()]) {
                isCorrect = fuzzyDict[currentBossWord.toLowerCase()].some(val => spoken.includes(val));
            }
            
            if (isCorrect) {
                isProcessing = true; score += 20; document.getElementById('boss-score-display').innerText = `Score: ${score}`;
                showFeedback('boss-feedback', true); speak("Excellent!"); 
                try { recognition.stop(); } catch(e) {}
                setTimeout(() => { if (isBossStageActive) { nextBossWord(); isProcessing = false; } }, 1500);
            } 
            else if (isFinalWord) {
                isProcessing = true; showFeedback('boss-feedback', false); speak("Try again!"); 
                setTimeout(() => { isProcessing = false; }, 1000);
            }
        };

        recognition.onend = () => { if(isMicActive && isBossStageActive) { setTimeout(() => { try { recognition.start(); } catch(e) {} }, 100); } };
    }

    function showResult() { document.getElementById('final-score').innerText = `Score: ${score}`; showScreen('result-screen'); }

    function saveScore() {
        const name = document.getElementById('player-name').value || "Student";
        const stars = score >= 150 ? "‚≠ê‚≠ê‚≠ê" : (score >= 80 ? "‚≠ê‚≠ê" : "‚≠ê");
        let history = JSON.parse(localStorage.getItem('monsterScores')) || [];
        history.push({ name, score, stars }); history.sort((a, b) => b.score - a.score);
        localStorage.setItem('monsterScores', JSON.stringify(history));
        displayLeaderboard(); showScreen('leaderboard-screen');
    }

    function displayLeaderboard() {
        const tbody = document.querySelector('#leaderboard-table tbody'); tbody.innerHTML = '';
        const history = JSON.parse(localStorage.getItem('monsterScores')) || [];
        history.forEach((d, i) => { tbody.innerHTML += `<tr><td>${i+1}</td><td>${d.name}</td><td>${d.score}</td><td>${d.stars}</td><td><button class="btn" style="padding: 5px 12px; font-size: 0.9rem; background-color:#ee5253;" onclick="deleteScore(${i})">Del</button></td></tr>`; });
    }

    function deleteScore(index) {
        if(confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠?")) {
            let history = JSON.parse(localStorage.getItem('monsterScores')) || [];
            history.splice(index, 1); localStorage.setItem('monsterScores', JSON.stringify(history));
            displayLeaderboard();
        }
    }
</script>
</body>
</html>